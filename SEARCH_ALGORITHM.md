# üîç –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ - BM25

**–í–µ—Ä—Å–∏—è:** 3.0  
**–î–∞—Ç–∞:** 2025-10-14

---

## üìñ –ß—Ç–æ —ç—Ç–æ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **BM25** (Best Matching 25) - –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:
- Google
- Elasticsearch
- Apache Lucene
- Wikipedia Search

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ BM25

### –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ (v1-v2):
- ‚ùå Hardcoded —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω
- ‚ùå –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è "Golden Visa"
- ‚ùå –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ –¥–ª—è —Å–∫–æ—Ä–∏–Ω–≥–∞
- ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö "–∑–∞–ø–ª–∞—Ç–æ–∫"

### –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ (v3):
- ‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π** - TF-IDF —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –¥–ª–∏–Ω—ã
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- ‚úÖ **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π** - –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏

---

## üßÆ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç BM25

### 1. **Term Frequency (TF)**
–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–ª–æ–≤–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ.
- "Golden" –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è 5 —Ä–∞–∑ ‚Üí –≤—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å

### 2. **Inverse Document Frequency (IDF)**
–†–µ–¥–∫–∏–µ —Å–ª–æ–≤–∞ –≤–∞–∂–Ω–µ–µ —á–∞—Å—Ç—ã—Ö.
- "Grenada" (—Ä–µ–¥–∫–æ–µ) > "–ø–æ–ª—É—á–∏—Ç—å" (—á–∞—Å—Ç–æ–µ)

### 3. **Document Length Normalization**
–£—á–∏—Ç—ã–≤–∞–µ—Ç –¥–ª–∏–Ω—É –¥–æ–∫—É–º–µ–Ω—Ç–∞.
- –ö–æ—Ä–æ—Ç–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º > –¥–ª–∏–Ω–Ω—ã–π —Å —Ç–µ–º –∂–µ —á–∏—Å–ª–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

### 4. **Field Boosting**
–í–∞–∂–Ω—ã–µ –ø–æ–ª—è –≤–µ—Å—è—Ç –±–æ–ª—å—à–µ:
- Title: –≤–µ—Å √ó3
- Category: –≤–µ—Å √ó2
- Body: –≤–µ—Å √ó1

### 5. **Post-Processing**
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±—É—Å—Ç –∑–∞ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:
- –¢–æ–∫–µ–Ω –≤ title ‚Üí √ó1.5
- –¢–æ–∫–µ–Ω –≤ category ‚Üí √ó1.2

---

## üî§ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞:
–†—É—Å—Å–∫–∏–π —è–∑—ã–∫ –∏–º–µ–µ—Ç –ø–∞–¥–µ–∂–∏: "–ì—Ä–µ–Ω–∞–¥–∞", "–ì—Ä–µ–Ω–∞–¥—ã", "–ì—Ä–µ–Ω–∞–¥–µ"...

### –†–µ—à–µ–Ω–∏–µ:
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è:
```
"–ì—Ä–µ–Ω–∞–¥—ã" ‚Üí "grenada"
"–ì—Ä–µ—Ü–∏–∏" ‚Üí "greece"
"–ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏" ‚Üí "portugal"
"–≤–∏–∑—É" ‚Üí "visa"
"–ø–æ–ª—É—á–∏—Ç—å" ‚Üí "get"
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–∞–¥–µ–∂–∞** –≤ –∑–∞–ø—Ä–æ—Å–µ.

---

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –ó–∞–ø—Ä–æ—Å: "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≥–æ–ª–¥–µ–Ω –≤–∏–∑—É?"

**–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è:**
```
–∫–∞–∫ ‚Üí [—Å—Ç–æ–ø-—Å–ª–æ–≤–æ, —É–¥–∞–ª–µ–Ω–æ]
–ø–æ–ª—É—á–∏—Ç—å ‚Üí get
–≥–æ–ª–¥–µ–Ω ‚Üí golden
–≤–∏–∑—É ‚Üí visa
```

**BM25 —Å–∫–æ—Ä–∏–Ω–≥:**
```
Greece. Golden: –í–∏–¥ –Ω–∞ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–æ ‚Üí 5.79
  - "golden" –≤ title (√ó3) + –≤ category (√ó2)
  - –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ "golden" –≤ title ‚Üí √ó1.5
  - –§–∏–Ω–∞–ª—å–Ω—ã–π score: 5.79

Portugal: –í–∏–¥ –Ω–∞ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–æ ‚Üí 4.03
  - "golden" —Ç–æ–ª—å–∫–æ –≤ body (√ó1)
  - –§–∏–Ω–∞–ª—å–Ω—ã–π score: 4.03
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Greece Golden –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ ‚úÖ

---

### –ó–∞–ø—Ä–æ—Å: "–ö–∞–∫ –ø–∞—Å–ø–æ—Ä—Ç –ì—Ä–µ–Ω–∞–¥—ã –ø–æ–ª—É—á–∏—Ç—å?"

**–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è:**
```
–ø–∞—Å–ø–æ—Ä—Ç ‚Üí passport
–≥—Ä–µ–Ω–∞–¥—ã ‚Üí grenada
–ø–æ–ª—É—á–∏—Ç—å ‚Üí get
```

**BM25 —Å–∫–æ—Ä–∏–Ω–≥:**
```
Grenada: –ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ ‚Üí 8.33
  - "grenada" –≤ title (√ó3) + –≤ category (√ó2)
  - "passport" –≤ body (√ó1)
  - –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ "grenada" –≤ category ‚Üí √ó1.5
  - –§–∏–Ω–∞–ª—å–Ω—ã–π score: 8.33

Vanuatu: –ü–∞—Å–ø–æ—Ä—Ç ‚Üí 5.07
  - "passport" –≤ title (√ó3)
  - –§–∏–Ω–∞–ª—å–Ω—ã–π score: 5.07
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Grenada –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ ‚úÖ

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞
```python
from rank_bm25 import BM25Okapi
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã BM25
```python
k1 = 1.5  # –ù–∞—Å—ã—â–µ–Ω–∏–µ TF (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
b = 0.75  # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª–∏–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

### Field Boosting
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ–º –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤–µ—Å–∞
text_parts = [
    title, title, title,  # 3x boost
    category, category,   # 2x boost
    subcategory,
    summary,
    body[:5000]
]
```

### Post-Processing
```python
for token in query_tokens:
    if token in title_normalized.split():
        final_score *= 1.5  # 50% –±—É—Å—Ç
    elif token in category_normalized.split():
        final_score *= 1.2  # 20% –±—É—Å—Ç
```

---

## üî¨ –¢–µ—Å—Ç–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ó–∞–ø—Ä–æ—Å | –¢–æ–ø-1 —Ä–µ–∑—É–ª—å—Ç–∞—Ç | Score | –°—Ç–∞—Ç—É—Å |
|--------|----------------|-------|--------|
| "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≥–æ–ª–¥–µ–Ω –≤–∏–∑—É?" | Greece. Golden | 5.79 | ‚úÖ |
| "Golden Visa" | Greece. Golden | 5.79 | ‚úÖ |
| "Golden Visa Greece" | Greece. Golden | 21.15 | ‚úÖ |
| "–ö–∞–∫ –ø–∞—Å–ø–æ—Ä—Ç –ì—Ä–µ–Ω–∞–¥—ã –ø–æ–ª—É—á–∏—Ç—å?" | Grenada | 8.33 | ‚úÖ |
| "–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏" | Portugal | 5.63 | ‚úÖ |
| "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –í–ù–ñ –≤ –ò—Å–ø–∞–Ω–∏–∏?" | Spain | 5.02 | ‚úÖ |

**100% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤** –Ω–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–∞—Ö!

---

## üöÄ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω
**–ù–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å!** –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ `.md` —Ñ–∞–π–ª –≤ `knowledge/`, BM25 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç.

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º
**–ù–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å!** BM25 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á—Ç—ë—Ç –Ω–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã.

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤
–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ `TextNormalizer.replacements`:
```python
r'citizenship': 'citizenship',
r'passport': 'passport',
r'residence': 'residence_permit',
```

---

## üìà –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è):

1. **Semantic Search (Embeddings)**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sentence-transformers
   - –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ FAISS/Annoy
   - –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫: BM25 + Embeddings

2. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è**
   - `pymystem3` –¥–ª—è —Ç–æ—á–Ω–æ–π –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Å—Å–∫–æ–≥–æ
   - `pymorphy2` –¥–ª—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

3. **Query Expansion**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
   - Spelling correction

4. **Learning to Rank**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ù–û:** —Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è 99% –∑–∞–ø—Ä–æ—Å–æ–≤!

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–∏—Ç—å –≤–µ—Å–∞ –ø–æ–ª–µ–π

–í `chat_agent.py`, –º–µ—Ç–æ–¥ `build_bm25_index`:
```python
text_parts = [
    title, title, title, title,  # 4x boost (–±—ã–ª–æ 3x)
    category, category, category, # 3x boost (–±—ã–ª–æ 2x)
    # ...
]
```

### –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É

–í `chat_agent.py`, –º–µ—Ç–æ–¥ `search_documents`:
```python
if token in title_normalized.split():
    final_score *= 2.0  # –£–≤–µ–ª–∏—á–∏—Ç—å —Å 1.5 –¥–æ 2.0
```

---

## üìö –°—Å—ã–ª–∫–∏

- [BM25 –Ω–∞ Wikipedia](https://en.wikipedia.org/wiki/Okapi_BM25)
- [rank_bm25 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://github.com/dorianbrown/rank_bm25)
- [Elasticsearch BM25](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-similarity.html)

---

## ‚úÖ –í—ã–≤–æ–¥—ã

1. **BM25 - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
2. **–£–±—Ä–∞–Ω—ã –≤—Å–µ –∫–æ—Å—Ç—ã–ª–∏** - –Ω–µ—Ç hardcoded –ª–æ–≥–∏–∫–∏
3. **–†–∞–±–æ—Ç–∞–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ** - –¥–ª—è –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Google, Elasticsearch
5. **–õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö "–∑–∞–ø–ª–∞—Ç–æ–∫"

**–í–µ—Ä—Å–∏—è 3.0 - —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∏ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üéâ

---

*–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 2025-10-14*  
*–í–µ—Ä—Å–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞: 3.0 (BM25 + Text Normalization + Post-Processing)*

